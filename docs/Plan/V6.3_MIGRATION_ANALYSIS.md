# ANALYSE DÉTAILLÉE MIGRATION V6.3

**Date**: 17 Janvier 2026
**Objectif**: Migration 10 statuts → 8 statuts + 5 phases → 4 phases

---

## 1. ÉTAT ACTUEL V6.2.1

### 1.1 Contrainte DB actuelle

```sql
-- Contrainte CHECK actuelle (10 statuts V6.2.1)
crm_leads_status_check CHECK (status IN (
  'new',
  'demo_scheduled',    -- À RENOMMER → 'demo'
  'qualified',         -- À SUPPRIMER
  'demo_completed',    -- À SUPPRIMER
  'proposal_sent',
  'payment_pending',
  'converted',
  'lost',
  'nurturing',
  'disqualified'
))
```

### 1.2 Phases Kanban actuelles (5 phases)

| Phase         | Statuts                                  | Fichier source                   |
| ------------- | ---------------------------------------- | -------------------------------- |
| Acquisition   | new, demo_scheduled                      | `lib/hooks/useLeadPhases.ts:111` |
| Qualification | qualified                                | `lib/hooks/useLeadPhases.ts:120` |
| Demo          | demo_completed                           | `lib/hooks/useLeadPhases.ts:129` |
| Closing       | proposal_sent, payment_pending           | `lib/hooks/useLeadPhases.ts:138` |
| Result        | converted, lost, nurturing, disqualified | `lib/hooks/useLeadPhases.ts:147` |

---

## 2. CIBLE V6.3

### 2.1 Nouvelle contrainte DB (8 statuts)

```sql
crm_leads_status_check CHECK (status IN (
  'new',
  'demo',              -- RENOMMÉ (ex demo_scheduled)
  'proposal_sent',
  'payment_pending',
  'converted',
  'lost',
  'nurturing',
  'disqualified'
))
```

### 2.2 Nouvelles phases Kanban (4 phases)

| Phase       | Key        | Statuts                                  |
| ----------- | ---------- | ---------------------------------------- |
| Incomplet   | incomplete | new                                      |
| Démo        | demo       | demo                                     |
| Proposition | proposal   | proposal_sent, payment_pending           |
| Terminé     | completed  | converted, lost, nurturing, disqualified |

---

## 3. MAPPING MIGRATION DONNÉES

| Ancien statut V6.2.1 | Nouveau statut V6.3 | Justification                                    |
| -------------------- | ------------------- | ------------------------------------------------ |
| `demo_scheduled`     | `demo`              | Renommage simple                                 |
| `qualified`          | `proposal_sent`     | One-call close: qualifié = proposition envoyée   |
| `demo_completed`     | `proposal_sent`     | One-call close: demo faite = proposition envoyée |

---

## 4. FICHIERS À MODIFIER

### 4.1 STATUTS: `demo_scheduled` → `demo` (13 fichiers)

| Fichier                                                       | Ligne                  | Contexte                   | Action   |
| ------------------------------------------------------------- | ---------------------- | -------------------------- | -------- |
| `lib/validators/crm/lead-status.validators.ts`                | 19                     | Enum definition            | Renommer |
| `lib/hooks/useLeadPhases.ts`                                  | 89,111,172,175,182,255 | Phase config + transitions | Renommer |
| `lib/services/crm/lead-status.service.ts`                     | 99                     | Doc example                | Renommer |
| `lib/services/crm/__tests__/lead-status.service.test.ts`      | 39-693                 | Tests                      | Renommer |
| `app/api/cron/demo-reminders/j1/route.ts`                     | 226                    | Status filter              | Renommer |
| `app/api/crm/webhooks/calcom/route.ts`                        | 182                    | newStatus assignment       | Renommer |
| `app/api/crm/leads/[id]/complete-wizard/route.ts`             | 140                    | newStatus assignment       | Renommer |
| `app/api/crm/leads/validate-booking/route.ts`                 | 67                     | Status check               | Renommer |
| `components/crm/leads/KanbanPhaseColumn.tsx`                  | 40                     | Color mapping              | Renommer |
| `components/crm/leads/KanbanPhaseBoard.tsx`                   | 5                      | Doc comment                | Renommer |
| `lib/services/billing/__tests__/payment-link.service.test.ts` | 213                    | Test data                  | Renommer |
| `lib/repositories/crm/__tests__/lead.repository.test.ts`      | 93                     | Test data                  | Renommer |
| `lib/services/crm/__tests__/lead-creation.service.test.ts`    | 337                    | Test data                  | Renommer |

### 4.2 STATUTS: `qualified` (STATUS, pas stage) → SUPPRIMER

**ATTENTION**: Distinguer `status: "qualified"` de `lead_stage: "sales_qualified"`

| Fichier                                                       | Ligne             | Contexte                           | Action                   |
| ------------------------------------------------------------- | ----------------- | ---------------------------------- | ------------------------ |
| `lib/validators/crm/lead-status.validators.ts`                | 20                | Enum                               | SUPPRIMER                |
| `lib/hooks/useLeadPhases.ts`                                  | 120,185-192       | Phase + transitions                | SUPPRIMER                |
| `lib/hooks/useLeadStatuses.ts`                                | 90-96             | Status definition                  | SUPPRIMER                |
| `lib/actions/crm/lead.actions.ts`                             | 34,126-128        | Status enum + qualified_date logic | MODIFIER                 |
| `lib/actions/crm/qualify.actions.ts`                          | 134-143           | Auto-status qualified              | MODIFIER → proposal_sent |
| `lib/actions/crm/bulk.actions.ts`                             | 37                | Status enum                        | SUPPRIMER qualified      |
| `lib/config/filter-config.ts`                                 | 204               | Status filter option               | SUPPRIMER                |
| `lib/validators/crm.validators.ts`                            | 258               | Status enum                        | SUPPRIMER qualified      |
| `lib/validators/crm/lead.validators.ts`                       | 220,401           | Status enum                        | SUPPRIMER qualified      |
| `lib/repositories/crm/lead.repository.ts`                     | 141               | Active statuses                    | MODIFIER                 |
| `lib/repositories/crm/settings.repository.ts`                 | 736,773-777       | Default settings                   | MODIFIER                 |
| `lib/services/crm/lead-qualification.service.ts`              | 318-323           | Auto-status update                 | MODIFIER → proposal_sent |
| `lib/services/crm/__tests__/lead-status.service.test.ts`      | 52-65             | Test data                          | SUPPRIMER                |
| `lib/services/billing/__tests__/payment-link.service.test.ts` | 62,87,263,296-369 | Tests                              | MODIFIER                 |
| `components/crm/leads/LeadsPageClient.tsx`                    | 373,376,412-413   | Status handling                    | SUPPRIMER                |
| `components/crm/leads/KanbanPhaseColumn.tsx`                  | 41                | Color mapping                      | SUPPRIMER                |
| `components/crm/leads/LeadsBrowserClient.tsx`                 | 65                | Status config                      | SUPPRIMER                |
| `components/crm/leads/LeadDetailHeader.tsx`                   | 78                | Status config                      | SUPPRIMER                |
| `components/crm/leads/LeadDrawerHeader.tsx`                   | 178               | Status check                       | MODIFIER                 |
| `components/crm/leads/EmptyColumn.tsx`                        | 70-73             | Empty state                        | SUPPRIMER                |
| `components/crm/leads/BulkStatusModal.tsx`                    | 33                | Status option                      | SUPPRIMER                |
| `components/crm/leads/LeadContextMenu.tsx`                    | 42                | Status option                      | SUPPRIMER                |
| `components/crm/leads/PaymentLinkSection.tsx`                 | 34                | Allowed statuses                   | MODIFIER                 |
| `components/crm/leads/utils/lead-utils.ts`                    | 17,41-48,63,68,93 | Status groups                      | SUPPRIMER                |
| `components/crm/leads/reports/*.tsx`                          | Multiple          | Report stats                       | MODIFIER                 |
| `components/app/widgets/DashboardGrid.tsx`                    | 95,106,676-802    | Dashboard widgets                  | MODIFIER                 |
| `app/api/v1/crm/leads/stats/route.ts`                         | 181-191,302-316   | Stats calculation                  | MODIFIER                 |
| `app/adm/leads/*.tsx`                                         | Multiple          | Admin pages                        | MODIFIER                 |
| `types/crm.ts`                                                | 16                | Type definition                    | SUPPRIMER                |
| `prisma/seed.ts`                                              | 318,340           | Seed data                          | MODIFIER                 |

### 4.3 STATUTS: `demo_completed` → SUPPRIMER

| Fichier                                                       | Ligne       | Contexte           | Action    |
| ------------------------------------------------------------- | ----------- | ------------------ | --------- |
| `lib/validators/crm/lead-status.validators.ts`                | 21          | Enum               | SUPPRIMER |
| `lib/hooks/useLeadPhases.ts`                                  | 129,195-202 | Phase + status def | SUPPRIMER |
| `lib/services/crm/__tests__/lead-status.service.test.ts`      | 65-70       | Test data          | SUPPRIMER |
| `lib/services/billing/__tests__/payment-link.service.test.ts` | 62,301-302  | Allowed statuses   | SUPPRIMER |
| `components/crm/leads/KanbanPhaseColumn.tsx`                  | 42          | Color mapping      | SUPPRIMER |
| `components/crm/leads/KanbanPhaseBoard.tsx`                   | 7           | Doc comment        | SUPPRIMER |
| `components/crm/leads/PaymentLinkSection.tsx`                 | 34          | Allowed statuses   | SUPPRIMER |

### 4.4 CHAMPS À CONSERVER (NE PAS TOUCHER)

| Champ/Concept                     | Raison                                 |
| --------------------------------- | -------------------------------------- |
| `qualified_date`                  | Colonne DB - date de qualification CPT |
| `lead_stage: marketing_qualified` | Stage différent de status              |
| `lead_stage: sales_qualified`     | Stage différent de status              |
| `disqualified`                    | Statut V6.3 valide                     |
| `nurturing`                       | Statut V6.3 valide                     |

---

## 5. TRANSITIONS V6.3 À IMPLÉMENTER

### 5.1 Matrice des transitions

```typescript
const ALLOWED_TRANSITIONS_V63: Record<LeadStatus, LeadStatus[]> = {
  new: ["demo", "nurturing", "disqualified"],
  demo: ["proposal_sent", "nurturing", "lost", "disqualified"],
  proposal_sent: ["payment_pending", "lost", "nurturing"],
  payment_pending: ["converted", "lost"],
  nurturing: ["demo", "proposal_sent", "lost"], // demo & proposal_sent = LEAD ACTION ONLY
  lost: ["nurturing"],
  converted: [], // TERMINAL
  disqualified: [], // TERMINAL
};
```

### 5.2 Transitions LEAD ACTION ONLY

```typescript
const LEAD_ACTION_ONLY_TRANSITIONS = [
  { from: "nurturing", to: "demo" }, // Lead clique "Book Demo" dans email
  { from: "nurturing", to: "proposal_sent" }, // Lead contacte commercial
];
```

---

## 6. RAISONS OBLIGATOIRES (DROPDOWNS)

### 6.1 Raisons pour `lost`

| Code               | Label FR               | Label EN         |
| ------------------ | ---------------------- | ---------------- |
| `not_interested`   | Pas intéressé          | Not interested   |
| `chose_competitor` | A choisi un concurrent | Chose competitor |
| `price_perception` | Prix perçu trop élevé  | Price perception |
| `bad_timing`       | Mauvais timing         | Bad timing       |
| `no_response`      | Ne répond plus         | No response      |
| `no_show`          | No-show au RDV         | No show          |

### 6.2 Raisons pour `disqualified`

| Code            | Label FR                     | Label EN      |
| --------------- | ---------------------------- | ------------- |
| `wrong_segment` | Mauvais segment (1 véhicule) | Wrong segment |
| `wrong_country` | Pays non couvert             | Wrong country |
| `spam_fake`     | Spam ou faux lead            | Spam/Fake     |
| `duplicate`     | Doublon                      | Duplicate     |
| `test_lead`     | Lead de test                 | Test lead     |

### 6.3 Raisons pour `nurturing`

| Code                  | Label FR               | Label EN            | Source     |
| --------------------- | ---------------------- | ------------------- | ---------- |
| `wizard_incomplete`   | Wizard non complété    | Incomplete wizard   | Système    |
| `country_waitlist`    | Pays non disponible    | Country waitlist    | Système    |
| `timing_q1`           | Recontacter Q1         | Recontact Q1        | Commercial |
| `timing_q2`           | Recontacter Q2         | Recontact Q2        | Commercial |
| `timing_6months`      | Dans 6 mois            | In 6 months         | Commercial |
| `budget_next_year`    | Budget année prochaine | Budget next year    | Commercial |
| `internal_discussion` | Discussion interne     | Internal discussion | Commercial |
| `needs_more_time`     | Demande plus de temps  | Needs more time     | Commercial |

---

## 7. COULEURS V6.3

| Statut            | Couleur | Hex       | TailwindCSS  |
| ----------------- | ------- | --------- | ------------ |
| `new`             | Gris    | `#6B7280` | `gray-500`   |
| `demo`            | Bleu    | `#3B82F6` | `blue-500`   |
| `proposal_sent`   | Orange  | `#F97316` | `orange-500` |
| `payment_pending` | Jaune   | `#EAB308` | `yellow-500` |
| `converted`       | Vert    | `#22C55E` | `green-500`  |
| `lost`            | Rouge   | `#EF4444` | `red-500`    |
| `nurturing`       | Violet  | `#8B5CF6` | `purple-500` |
| `disqualified`    | Noir    | `#1F2937` | `gray-800`   |

---

## 8. ORDRE D'EXÉCUTION

```
ÉTAPE 1: Migration SQL (Supabase)
├── 1.1 Migrer données: demo_scheduled → demo
├── 1.2 Migrer données: qualified → proposal_sent
├── 1.3 Migrer données: demo_completed → proposal_sent
├── 1.4 Vérifier aucun ancien statut restant
├── 1.5 DROP ancienne contrainte
├── 1.6 CREATE nouvelle contrainte (8 statuts)
└── 1.7 UPDATE crm_settings.lead_status_workflow

ÉTAPE 2: Backend TypeScript
├── 2.1 Modifier lib/validators/crm/lead-status.validators.ts
├── 2.2 Modifier lib/hooks/useLeadPhases.ts (4 phases)
├── 2.3 Modifier lib/hooks/useLeadStatuses.ts
├── 2.4 Modifier types/crm.ts
├── 2.5 Modifier tous les fichiers avec anciens statuts
└── 2.6 Mettre à jour tests

ÉTAPE 3: Traductions i18n
├── 3.1 Modifier lib/i18n/locales/en/crm.json
└── 3.2 Modifier lib/i18n/locales/fr/crm.json

ÉTAPE 4: Frontend Components
├── 4.1 Modifier KanbanPhaseColumn.tsx
├── 4.2 Modifier KanbanPhaseBoard.tsx
├── 4.3 Modifier LeadDetailPage.tsx (CPT + dropdowns)
├── 4.4 Modifier LeadsBrowserClient.tsx
├── 4.5 Modifier tous les composants avec anciens statuts
└── 4.6 Désactiver bouton nurturing→demo dans UI

ÉTAPE 5: API Routes
├── 5.1 Modifier leads/[id]/status/route.ts (validation transitions)
├── 5.2 Ajouter triggered_by validation
└── 5.3 Modifier webhooks/calcom/route.ts
```

---

## 9. FICHIERS COMPTÉS PAR CATÉGORIE

| Catégorie                        | Fichiers         | Lignes impactées |
| -------------------------------- | ---------------- | ---------------- |
| `demo_scheduled` → `demo`        | 13               | ~50              |
| `qualified` (status) → SUPPRIMER | ~35              | ~150             |
| `demo_completed` → SUPPRIMER     | 7                | ~20              |
| Tests à modifier                 | 8                | ~100             |
| **TOTAL**                        | **~50 fichiers** | **~320 lignes**  |

---

## 10. RISQUES ET POINTS D'ATTENTION

### 10.1 Risques

| Risque                                                  | Mitigation                     |
| ------------------------------------------------------- | ------------------------------ |
| Confusion `qualified` status vs `sales_qualified` stage | Recherche précise par contexte |
| Leads en production avec anciens statuts                | Migration SQL AVANT code       |
| Tests cassés                                            | Mise à jour complète des tests |

### 10.2 Points d'attention

- **NE PAS TOUCHER**: `qualified_date`, `lead_stage`, `marketing_qualified`, `sales_qualified`
- **RÈGLE CRITIQUE**: `nurturing → demo` = LEAD ACTION ONLY (pas de bouton UI)
- **ZERO HARDCODING**: Lire depuis crm_settings autant que possible

---

**FIN DE L'ANALYSE DÉTAILLÉE**
