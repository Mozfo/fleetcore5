// ============================================================================
// REVENUE MODULE (REV) - Prisma Schema
// Description: Revenue management, imports, reconciliation, and driver payments
// Version: V2
// Generated: 2025-11-02
// Tables: 4 (3 MODIFY + 1 NEW)
// ============================================================================

// ============================================================================
// ENUMS - Revenue Module Specific
// ============================================================================

// Status for revenue imports
enum RevenueImportStatus {
  pending              // Import scheduled but not started
  processing           // Currently processing file/API data
  completed            // Successfully completed
  partially_completed  // Some rows failed but import continued
  failed               // Complete failure
  cancelled            // Manually cancelled

  @@map("revenue_import_status")
}

// Source type for revenue imports
enum RevenueImportSourceType {
  api          // Direct API integration (Uber, Bolt)
  file_csv     // CSV file upload
  file_excel   // Excel file upload
  manual       // Manual data entry

  @@map("revenue_import_source_type")
}

// Status for driver revenues
enum DriverRevenueStatus {
  pending    // Calculated but not yet validated
  validated  // Validated and approved for payment
  adjusted   // Manually adjusted after validation
  disputed   // Driver disputed the amount

  @@map("driver_revenue_status")
}

// Period type for revenue calculation
enum DriverRevenuePeriodType {
  week      // Weekly payment cycle
  biweekly  // Bi-weekly payment cycle
  month     // Monthly payment cycle

  @@map("driver_revenue_period_type")
}

// Status for reconciliations
enum ReconciliationStatus {
  pending      // Waiting for bank transfer/cash collection
  matched      // Perfect match (difference within tolerance)
  mismatched   // Difference detected, requires investigation
  adjusted     // Manually adjusted and resolved
  cancelled    // Reconciliation cancelled

  @@map("reconciliation_status")
}

// Type of reconciliation
enum ReconciliationType {
  platform_payment  // Payment received from platform (Uber, Bolt)
  cash_collection   // Cash collected from drivers
  bank_statement    // Bank statement reconciliation
  adjustment        // Manual adjustment/correction

  @@map("reconciliation_type")
}

// ============================================================================
// TABLE 1: rev_revenue_imports (MODIFY)
// Description: Import of revenue data from platforms (Uber, Bolt, Careem)
// Source: Lines 43-169 in FLEETCORE_TABLES_REV_ONLY.md
// ============================================================================

model RevRevenueImport {
  // =========================================
  // PRIMARY KEY & IDENTIFICATION
  // =========================================
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  importReference  String   @db.VarChar(255)  // Unique identifier for the import file

  // =========================================
  // SOURCE & TRACEABILITY
  // =========================================
  platformId       String?  @db.Uuid          // FK to dir_platforms (Uber, Bolt, etc.)
  sourceType       RevenueImportSourceType    // api, file_csv, file_excel, manual
  fileUrl          String?  @db.Text          // Path to stored original file
  importDate       DateTime @db.Date

  // =========================================
  // AMOUNTS & CURRENCIES
  // =========================================
  sourceCurrency   String   @db.Char(3)       // Original currency from platform (AED, EUR, etc.)
  exchangeRate     Decimal? @db.Decimal(12, 6) // Exchange rate applied for conversion
  totalRevenue     Decimal  @db.Decimal(18, 2) // Total revenue in source currency
  convertedAmount  Decimal? @db.Decimal(18, 2) // Amount after conversion to tenant currency

  // =========================================
  // STATISTICS & QUALITY METRICS
  // =========================================
  rowsCount        Int?     @default(0)       // Number of rows imported
  errorsCount      Int?     @default(0)       // Number of errors detected
  warningsCount    Int?     @default(0)       // Number of non-blocking warnings
  
  processingStartedAt   DateTime? @db.Timestamptz(6)
  processingCompletedAt DateTime? @db.Timestamptz(6)
  // processingDuration is a GENERATED column in PostgreSQL: processing_completed_at - processing_started_at

  // =========================================
  // STATUS & ERROR MANAGEMENT
  // =========================================
  status           RevenueImportStatus @default(pending)
  statusReason     String?  @db.Text          // Explanation of current status
  retryCount       Int      @default(0)       // Number of retry attempts
  lastError        String?  @db.Text          // Last error message

  // =========================================
  // AUDIT TRAIL (Standard)
  // =========================================
  metadata         Json?    @db.JsonB         // Extensible metadata
  
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  createdBy        String   @db.Uuid
  
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)
  updatedBy        String?  @db.Uuid
  
  deletedAt        DateTime? @db.Timestamptz(6)
  deletedBy        String?   @db.Uuid
  deletionReason   String?   @db.Text

  // =========================================
  // RELATIONS
  // =========================================
  tenant           AdmTenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  platform         DirPlatform? @relation(fields: [platformId], references: [id], onDelete: Restrict)
  
  createdByUser    AdmMember  @relation("RevRevenueImportCreatedBy", fields: [createdBy], references: [id])
  updatedByUser    AdmMember? @relation("RevRevenueImportUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser    AdmMember? @relation("RevRevenueImportDeletedBy", fields: [deletedBy], references: [id])

  // Downstream relations
  driverRevenues   RevDriverRevenue[]
  reconciliations  RevReconciliation[]

  // =========================================
  // INDEXES & CONSTRAINTS
  // =========================================
  @@unique([tenantId, importReference], name: "uq_rev_revenue_imports_tenant_reference")
  @@index([tenantId, status], name: "idx_rev_revenue_imports_tenant_status")
  @@index([tenantId, importDate], name: "idx_rev_revenue_imports_tenant_date")
  @@index([platformId], name: "idx_rev_revenue_imports_platform")
  @@index([status, processingStartedAt], name: "idx_rev_revenue_imports_status_started")
  
  @@map("rev_revenue_imports")
}

// ============================================================================
// TABLE 2: rev_driver_revenues (MODIFY)
// Description: Aggregated revenues per driver per period with platform breakdown
// Source: Lines 172-321 in FLEETCORE_TABLES_REV_ONLY.md
// ============================================================================

model RevDriverRevenue {
  // =========================================
  // PRIMARY KEY & IDENTIFICATION
  // =========================================
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  driverId         String   @db.Uuid
  platformId       String?  @db.Uuid          // NULL = consolidated all platforms

  // =========================================
  // PERIOD INFORMATION
  // =========================================
  periodStart      DateTime @db.Date
  periodEnd        DateTime @db.Date
  periodType       DriverRevenuePeriodType     // week, biweekly, month

  // =========================================
  // AMOUNTS
  // =========================================
  totalRevenue     Decimal  @db.Decimal(18, 2) // Gross revenue before commissions
  commissionAmount Decimal  @db.Decimal(18, 2) // Total commission deducted
  netRevenue       Decimal  @db.Decimal(18, 2) // Net amount payable to driver
  currency         String   @db.Char(3)        // Currency of amounts (AED, EUR, etc.)

  // =========================================
  // TRACEABILITY & VALIDATION
  // =========================================
  importId         String   @db.Uuid           // FK to rev_revenue_imports
  status           DriverRevenueStatus @default(pending)
  
  validatedBy      String?  @db.Uuid           // FK to adm_members
  validatedAt      DateTime? @db.Timestamptz(6)
  adjustmentReason String?  @db.Text           // Reason for manual adjustment

  // =========================================
  // AUDIT TRAIL (Standard)
  // =========================================
  metadata         Json?    @db.JsonB         // Extended breakdown (see spec lines 262-274)
  
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  createdBy        String   @db.Uuid
  
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)
  updatedBy        String?  @db.Uuid
  
  deletedAt        DateTime? @db.Timestamptz(6)
  deletedBy        String?   @db.Uuid
  deletionReason   String?   @db.Text

  // =========================================
  // RELATIONS
  // =========================================
  tenant           AdmTenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driver           RidDriver  @relation(fields: [driverId], references: [id], onDelete: Restrict)
  platform         DirPlatform? @relation(fields: [platformId], references: [id], onDelete: Restrict)
  import           RevRevenueImport @relation(fields: [importId], references: [id], onDelete: Restrict)
  
  validatedByUser  AdmMember? @relation("RevDriverRevenueValidatedBy", fields: [validatedBy], references: [id])
  createdByUser    AdmMember  @relation("RevDriverRevenueCreatedBy", fields: [createdBy], references: [id])
  updatedByUser    AdmMember? @relation("RevDriverRevenueUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser    AdmMember? @relation("RevDriverRevenueDeletedBy", fields: [deletedBy], references: [id])

  // =========================================
  // INDEXES & CONSTRAINTS
  // =========================================
  @@unique([tenantId, driverId, platformId, periodStart], name: "uq_rev_driver_revenues_tenant_driver_platform_period")
  @@index([tenantId, driverId, periodStart], name: "idx_rev_driver_revenues_tenant_driver_period")
  @@index([tenantId, status], name: "idx_rev_driver_revenues_tenant_status")
  @@index([importId], name: "idx_rev_driver_revenues_import")
  @@index([platformId], name: "idx_rev_driver_revenues_platform")
  
  @@map("rev_driver_revenues")
}

// ============================================================================
// TABLE 3: rev_reconciliations (MODIFY)
// Description: Reconciliation of expected vs received amounts
// Source: Lines 325-480 in FLEETCORE_TABLES_REV_ONLY.md
// ============================================================================

model RevReconciliation {
  // =========================================
  // PRIMARY KEY & IDENTIFICATION
  // =========================================
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @db.Uuid
  importId            String   @db.Uuid           // FK to rev_revenue_imports
  reconciliationDate  DateTime @db.Date

  // =========================================
  // TYPE & AMOUNTS
  // =========================================
  reconciliationType  ReconciliationType         // platform_payment, cash_collection, etc.
  expectedAmount      Decimal  @db.Decimal(18, 2) // Calculated from rev_driver_revenues
  receivedAmount      Decimal  @db.Decimal(18, 2) // Actual amount received
  // differenceAmount is GENERATED: received_amount - expected_amount
  toleranceAmount     Decimal  @db.Decimal(18, 2) // Acceptable difference (e.g., 5 AED)
  currency            String   @db.Char(3)

  // =========================================
  // STATUS & WORKFLOW
  // =========================================
  status              ReconciliationStatus @default(pending)
  autoMatched         Boolean  @default(false)    // TRUE if auto-matched within tolerance
  
  assignedTo          String?  @db.Uuid           // FK to adm_members (responsible)
  resolvedAt          DateTime? @db.Timestamptz(6)
  resolvedBy          String?   @db.Uuid          // FK to adm_members
  resolutionNotes     String?   @db.Text
  requiresAction      Boolean   @default(false)   // TRUE if manual action needed

  // =========================================
  // DOCUMENTATION
  // =========================================
  notes               String?  @db.Text

  // =========================================
  // AUDIT TRAIL (Standard)
  // =========================================
  metadata            Json?    @db.JsonB
  
  createdAt           DateTime @default(now()) @db.Timestamptz(6)
  createdBy           String   @db.Uuid
  
  updatedAt           DateTime @updatedAt @db.Timestamptz(6)
  updatedBy           String?  @db.Uuid
  
  deletedAt           DateTime? @db.Timestamptz(6)
  deletedBy           String?   @db.Uuid
  deletionReason      String?   @db.Text

  // =========================================
  // RELATIONS
  // =========================================
  tenant              AdmTenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  import              RevRevenueImport @relation(fields: [importId], references: [id], onDelete: Restrict)
  
  assignedToUser      AdmMember? @relation("RevReconciliationAssignedTo", fields: [assignedTo], references: [id])
  resolvedByUser      AdmMember? @relation("RevReconciliationResolvedBy", fields: [resolvedBy], references: [id])
  createdByUser       AdmMember  @relation("RevReconciliationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser       AdmMember? @relation("RevReconciliationUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser       AdmMember? @relation("RevReconciliationDeletedBy", fields: [deletedBy], references: [id])

  // Downstream relations
  lines               RevReconciliationLine[]

  // =========================================
  // INDEXES & CONSTRAINTS
  // =========================================
  @@unique([tenantId, importId, reconciliationDate], name: "uq_rev_reconciliations_tenant_import_date")
  @@index([tenantId, status], name: "idx_rev_reconciliations_tenant_status")
  @@index([tenantId, reconciliationDate], name: "idx_rev_reconciliations_tenant_date")
  @@index([importId], name: "idx_rev_reconciliations_import")
  @@index([assignedTo], name: "idx_rev_reconciliations_assigned")
  @@index([status, requiresAction], name: "idx_rev_reconciliations_status_action")
  
  @@map("rev_reconciliations")
}

// ============================================================================
// TABLE 4: rev_reconciliation_lines (NEW)
// Description: Detailed breakdown of reconciliation differences per driver/platform
// Source: Lines 483-497 in FLEETCORE_TABLES_REV_ONLY.md
// ============================================================================

model RevReconciliationLine {
  // =========================================
  // PRIMARY KEY & IDENTIFICATION
  // =========================================
  id                  String   @id @default(uuid()) @db.Uuid
  reconciliationId    String   @db.Uuid           // FK to rev_reconciliations
  
  // =========================================
  // BREAKDOWN DIMENSIONS (Optional)
  // =========================================
  driverId            String?  @db.Uuid           // FK to rid_drivers (if applicable)
  platformId          String?  @db.Uuid           // FK to dir_platforms (if applicable)

  // =========================================
  // AMOUNTS
  // =========================================
  expectedAmount      Decimal  @db.Decimal(18, 2)
  receivedAmount      Decimal  @db.Decimal(18, 2)
  // differenceAmount is GENERATED: received_amount - expected_amount

  // =========================================
  // DOCUMENTATION
  // =========================================
  notes               String?  @db.Text
  metadata            Json?    @db.JsonB

  // =========================================
  // RELATIONS
  // =========================================
  reconciliation      RevReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  driver              RidDriver? @relation(fields: [driverId], references: [id], onDelete: Restrict)
  platform            DirPlatform? @relation(fields: [platformId], references: [id], onDelete: Restrict)

  // =========================================
  // INDEXES
  // =========================================
  @@index([reconciliationId], name: "idx_rev_reconciliation_lines_reconciliation")
  @@index([driverId], name: "idx_rev_reconciliation_lines_driver")
  @@index([platformId], name: "idx_rev_reconciliation_lines_platform")
  
  @@map("rev_reconciliation_lines")
}

// ============================================================================
// NOTES ON IMPLEMENTATION
// ============================================================================

// 1. GENERATED COLUMNS (PostgreSQL):
//    - RevRevenueImport.processingDuration: processing_completed_at - processing_started_at
//    - RevReconciliation.differenceAmount: received_amount - expected_amount
//    - RevReconciliationLine.differenceAmount: received_amount - expected_amount
//    These are computed columns and not stored in Prisma schema but exist in DB

// 2. MULTI-CURRENCY SUPPORT:
//    - All amounts store currency explicitly (AED, EUR, USD, etc.)
//    - Exchange rates stored in rev_revenue_imports for traceability
//    - Conversion from source currency to tenant currency tracked

// 3. WORKFLOW:
//    Import (rev_revenue_imports) 
//    → Calculate (rev_driver_revenues)
//    → Reconcile (rev_reconciliations)
//    → Investigate (rev_reconciliation_lines)
//    → Pay (fin_driver_payments - in FIN module)

// 4. UNIQUE CONSTRAINTS:
//    - rev_revenue_imports: (tenant_id, import_reference)
//    - rev_driver_revenues: (tenant_id, driver_id, platform_id, period_start)
//      → Allows multiple lines per driver per period (one per platform + one consolidated with platform_id=NULL)
//    - rev_reconciliations: (tenant_id, import_id, reconciliation_date)

// 5. SOFT DELETE:
//    All tables support soft delete (deleted_at, deleted_by, deletion_reason)
//    Unique constraints should have WHERE deleted_at IS NULL in PostgreSQL

// 6. RELATIONS TO OTHER MODULES:
//    - AdmTenant: Multi-tenant isolation
//    - AdmMember: Audit trail (created_by, updated_by, validated_by, etc.)
//    - DirPlatform: Source platforms (Uber, Bolt, Careem)
//    - RidDriver: Driver revenues belong to specific drivers
//    - FinDriverPayment (future): Payments generated from validated revenues

// 7. METADATA JSON STRUCTURE (examples):
//    rev_driver_revenues.metadata:
//    {
//      "trips_count": 145,
//      "platform_commission_rate": 0.25,
//      "platform_commission_amount": 1250.00,
//      "fleetcore_commission_rate": 0.10,
//      "fleetcore_commission_amount": 375.00,
//      "fuel_deductions": 200.00,
//      "fine_deductions": 50.00,
//      "advance_deductions": 100.00
//    }

// 8. BUSINESS RULES (enforced in application logic):
//    - Cannot create fin_driver_payments until rev_driver_revenues.status = 'validated'
//    - Cannot validate revenue if reconciliation.status != 'matched' OR 'adjusted'
//    - Auto-match reconciliation if |difference| <= tolerance_amount
//    - SUM(rev_driver_revenues.total_revenue WHERE import_id = X) MUST EQUAL rev_revenue_imports.total_revenue

// ============================================================================
// END OF REVENUE MODULE SCHEMA
// ============================================================================
