// ============================================================================
// MODULE SCHEDULING (SCH) - Prisma Schema
// ============================================================================
// Version: 2.0
// Date: 2025-11-02
// Tables: 11 tables (4 MODIFY + 7 NEW)
// Description: Planning shifts, maintenance préventive, objectifs KPI, workflow tâches
// ============================================================================

// ============================================================================
// ENUMS - Module Scheduling
// ============================================================================

enum ShiftType {
  day
  night
  weekend
  peak_hour
  special_event

  @@map("shift_type")
}

enum ShiftStatus {
  scheduled
  completed
  cancelled
  no_show
  partial

  @@map("shift_status")
}

enum MaintenancePriority {
  low
  normal
  high
  urgent
  critical

  @@map("maintenance_priority")
}

enum MaintenanceTriggerType {
  mileage_based
  time_based
  condition_based
  manual

  @@map("maintenance_trigger_type")
}

enum MaintenanceStatus {
  scheduled
  completed
  cancelled
  overdue
  in_progress
  rescheduled

  @@map("maintenance_status")
}

enum MaintenanceCategory {
  preventive
  corrective
  regulatory

  @@map("maintenance_category")
}

enum GoalCategory {
  revenue
  trips
  quality
  efficiency
  safety

  @@map("goal_category")
}

enum GoalTargetType {
  individual
  team
  branch
  company

  @@map("goal_target_type")
}

enum GoalPeriodType {
  daily
  weekly
  monthly
  quarterly
  yearly

  @@map("goal_period_type")
}

enum GoalRewardType {
  bonus
  certificate
  badge
  promotion

  @@map("goal_reward_type")
}

enum GoalStatus {
  active
  in_progress
  completed
  cancelled
  expired
  on_track
  at_risk
  achieved
  exceeded

  @@map("goal_status")
}

enum GoalThreshold {
  bronze
  silver
  gold
  exceeded

  @@map("goal_threshold")
}

enum TaskCategory {
  admin
  maintenance
  document
  training
  support

  @@map("task_category")
}

enum TaskPriority {
  low
  normal
  high
  urgent
  critical

  @@map("task_priority")
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
  overdue
  blocked
  waiting_verification
  reopened

  @@map("task_status")
}

enum TaskCommentType {
  note
  status_change
  escalation

  @@map("task_comment_type")
}

enum TaskChangeType {
  created
  assigned
  status_changed
  escalated

  @@map("task_change_type")
}

enum AggregationType {
  sum
  avg
  count
  min
  max

  @@map("aggregation_type")
}

// ============================================================================
// MODELS - Module Scheduling
// ============================================================================

// ----------------------------------------------------------------------------
// TABLE 1/11: sch_shift_types (NEW)
// Description: Types de shifts référentiel avec coefficients prime
// ----------------------------------------------------------------------------
model SchShiftType {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String?  @map("tenant_id") @db.Uuid
  code           String   @db.VarChar(50)
  label          String   @db.VarChar(255)
  payMultiplier  Decimal  @map("pay_multiplier") @db.Decimal(4, 2)
  colorCode      String?  @map("color_code") @db.VarChar(20)
  isActive       Boolean  @default(true) @map("is_active")
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy      String   @map("created_by") @db.Uuid
  updatedBy      String?  @map("updated_by") @db.Uuid
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy      String?   @map("deleted_by") @db.Uuid
  deletionReason String?   @map("deletion_reason") @db.Text

  // Relations
  tenant          AdmTenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser   AdmProviderEmployee   @relation("SchShiftTypeCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   AdmProviderEmployee?  @relation("SchShiftTypeUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser   AdmProviderEmployee?  @relation("SchShiftTypeDeletedBy", fields: [deletedBy], references: [id])
  shifts          SchShift[]

  @@unique([tenantId, code, deletedAt], name: "sch_shift_types_tenant_code_unique")
  @@index([isActive, deletedAt])
  @@map("sch_shift_types")
}

// ----------------------------------------------------------------------------
// TABLE 2/11: sch_shifts (MODIFY)
// Description: Planning conducteurs avancé avec check-in/out temps réel
// ----------------------------------------------------------------------------
model SchShift {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @map("tenant_id") @db.Uuid
  driverId              String    @map("driver_id") @db.Uuid
  shiftTypeId           String?   @map("shift_type_id") @db.Uuid
  shiftCategory         String?   @map("shift_category") @db.VarChar(50)
  locationId            String?   @map("location_id") @db.Uuid
  zoneName              String?   @map("zone_name") @db.VarChar(255)
  startTime             DateTime  @map("start_time") @db.Timestamptz(6)
  endTime               DateTime  @map("end_time") @db.Timestamptz(6)
  checkInAt             DateTime? @map("check_in_at") @db.Timestamptz(6)
  checkOutAt            DateTime? @map("check_out_at") @db.Timestamptz(6)
  breakDurationMinutes  Int?      @map("break_duration_minutes")
  actualWorkMinutes     Int?      @map("actual_work_minutes")
  payMultiplier         Decimal?  @map("pay_multiplier") @db.Decimal(4, 2)
  status                ShiftStatus
  approvedBy            String?   @map("approved_by") @db.Uuid
  approvedAt            DateTime? @map("approved_at") @db.Timestamptz(6)
  notes                 String?   @db.Text
  cancellationReason    String?   @map("cancellation_reason") @db.VarChar(255)
  replacementDriverId   String?   @map("replacement_driver_id") @db.Uuid
  metadata              Json?     @db.JsonB
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy             String    @map("created_by") @db.Uuid
  updatedBy             String?   @map("updated_by") @db.Uuid
  deletedAt             DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy             String?   @map("deleted_by") @db.Uuid
  deletionReason        String?   @map("deletion_reason") @db.Text

  // Relations
  tenant              AdmTenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driver              RidDriver             @relation("SchShiftDriver", fields: [driverId], references: [id])
  shiftType           SchShiftType?         @relation(fields: [shiftTypeId], references: [id])
  location            SchLocation?          @relation(fields: [locationId], references: [id])
  approver            AdmMember?            @relation("SchShiftApprover", fields: [approvedBy], references: [id])
  replacementDriver   RidDriver?            @relation("SchShiftReplacement", fields: [replacementDriverId], references: [id])
  createdByUser       AdmProviderEmployee   @relation("SchShiftCreatedBy", fields: [createdBy], references: [id])
  updatedByUser       AdmProviderEmployee?  @relation("SchShiftUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser       AdmProviderEmployee?  @relation("SchShiftDeletedBy", fields: [deletedBy], references: [id])

  @@unique([tenantId, driverId, startTime, deletedAt], name: "sch_shifts_tenant_driver_start_unique")
  @@index([driverId, checkInAt])
  @@index([shiftTypeId, locationId])
  @@index([checkInAt])
  @@index([checkOutAt])
  @@index([status, deletedAt])
  @@map("sch_shifts")
}

// ----------------------------------------------------------------------------
// TABLE 3/11: dir_maintenance_types (NEW - dans module DIR mais utilisé par SCH)
// Description: Types maintenances référentiel avec fréquence
// Note: Ce modèle est partagé entre DIR et SCH
// ----------------------------------------------------------------------------
model DirMaintenanceType {
  id                       String    @id @default(uuid()) @db.Uuid
  tenantId                 String?   @map("tenant_id") @db.Uuid
  code                     String    @db.VarChar(50)
  label                    String    @db.VarChar(255)
  category                 MaintenanceCategory
  defaultFrequencyKm       Int?      @map("default_frequency_km")
  defaultFrequencyMonths   Int?      @map("default_frequency_months")
  estimatedDurationHours   Decimal?  @map("estimated_duration_hours") @db.Decimal(5, 2)
  estimatedCostRange       Json?     @map("estimated_cost_range") @db.JsonB
  isMandatory              Boolean   @default(false) @map("is_mandatory")
  requiresVehicleStoppage  Boolean   @default(true) @map("requires_vehicle_stoppage")
  description              String?   @db.Text
  metadata                 Json?     @db.JsonB
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy                String    @map("created_by") @db.Uuid
  updatedBy                String?   @map("updated_by") @db.Uuid
  deletedAt                DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy                String?   @map("deleted_by") @db.Uuid
  deletionReason           String?   @map("deletion_reason") @db.Text

  // Relations
  tenant                 AdmTenant?                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser          AdmProviderEmployee         @relation("DirMaintenanceTypeCreatedBy", fields: [createdBy], references: [id])
  updatedByUser          AdmProviderEmployee?        @relation("DirMaintenanceTypeUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser          AdmProviderEmployee?        @relation("DirMaintenanceTypeDeletedBy", fields: [deletedBy], references: [id])
  maintenanceSchedules   SchMaintenanceSchedule[]

  @@unique([tenantId, code, deletedAt], name: "dir_maintenance_types_tenant_code_unique")
  @@index([category, isMandatory])
  @@index([deletedAt])
  @@map("dir_maintenance_types")
}

// ----------------------------------------------------------------------------
// TABLE 4/11: sch_maintenance_schedules (MODIFY)
// Description: Maintenance préventive avec rappels automatiques
// ----------------------------------------------------------------------------
model SchMaintenanceSchedule {
  id                      String              @id @default(uuid()) @db.Uuid
  tenantId                String              @map("tenant_id") @db.Uuid
  vehicleId               String              @map("vehicle_id") @db.Uuid
  maintenanceTypeId       String?             @map("maintenance_type_id") @db.Uuid
  scheduledDate           DateTime            @map("scheduled_date") @db.Date
  scheduledBy             String?             @map("scheduled_by") @db.Uuid
  priority                MaintenancePriority @default(normal)
  estimatedDurationHours  Decimal?            @map("estimated_duration_hours") @db.Decimal(5, 2)
  estimatedCost           Decimal?            @map("estimated_cost") @db.Decimal(10, 2)
  odometerReading         Int?                @map("odometer_reading")
  triggerType             MaintenanceTriggerType? @map("trigger_type")
  reminderSentAt          DateTime?           @map("reminder_sent_at") @db.Timestamptz(6)
  reminderCount           Int                 @default(0) @map("reminder_count")
  completedMaintenanceId  String?             @map("completed_maintenance_id") @db.Uuid
  rescheduledFrom         String?             @map("rescheduled_from") @db.Uuid
  rescheduledReason       String?             @map("rescheduled_reason") @db.Text
  blockingOperations      Boolean             @default(false) @map("blocking_operations")
  requiredParts           Json?               @map("required_parts") @db.JsonB
  assignedGarage          String?             @map("assigned_garage") @db.VarChar(255)
  garageContact           String?             @map("garage_contact") @db.VarChar(255)
  notes                   String?             @db.Text
  status                  MaintenanceStatus   @default(scheduled)
  metadata                Json?               @db.JsonB
  createdAt               DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy               String              @map("created_by") @db.Uuid
  updatedBy               String?             @map("updated_by") @db.Uuid
  deletedAt               DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedBy               String?             @map("deleted_by") @db.Uuid
  deletionReason          String?             @map("deletion_reason") @db.Text

  // Relations
  tenant                  AdmTenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle                 FltVehicle                   @relation(fields: [vehicleId], references: [id])
  maintenanceType         DirMaintenanceType?          @relation(fields: [maintenanceTypeId], references: [id])
  scheduler               AdmMember?                   @relation("SchMaintenanceScheduledBy", fields: [scheduledBy], references: [id])
  completedMaintenance    FltVehicleMaintenance?       @relation(fields: [completedMaintenanceId], references: [id])
  rescheduledFromSchedule SchMaintenanceSchedule?      @relation("MaintenanceRescheduled", fields: [rescheduledFrom], references: [id])
  rescheduledSchedules    SchMaintenanceSchedule[]     @relation("MaintenanceRescheduled")
  createdByUser           AdmProviderEmployee          @relation("SchMaintenanceScheduleCreatedBy", fields: [createdBy], references: [id])
  updatedByUser           AdmProviderEmployee?         @relation("SchMaintenanceScheduleUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser           AdmProviderEmployee?         @relation("SchMaintenanceScheduleDeletedBy", fields: [deletedBy], references: [id])

  @@unique([tenantId, vehicleId, scheduledDate, maintenanceTypeId, deletedAt], name: "sch_maintenance_schedules_unique")
  @@index([vehicleId, scheduledDate, status])
  @@index([triggerType, priority])
  @@index([reminderSentAt])
  @@index([odometerReading])
  @@index([status, deletedAt])
  @@map("sch_maintenance_schedules")
}

// ----------------------------------------------------------------------------
// TABLE 5/11: sch_goal_types (NEW)
// Description: Types objectifs KPI référentiel avec calcul automatique
// ----------------------------------------------------------------------------
model SchGoalType {
  id                 String           @id @default(uuid()) @db.Uuid
  tenantId           String?          @map("tenant_id") @db.Uuid
  code               String           @db.VarChar(50)
  label              String           @db.VarChar(255)
  category           GoalCategory
  unit               String           @db.VarChar(50)
  calculationMethod  String?          @map("calculation_method") @db.Text
  dataSourceTable    String?          @map("data_source_table") @db.VarChar(100)
  dataSourceField    String?          @map("data_source_field") @db.VarChar(100)
  aggregationType    AggregationType? @map("aggregation_type")
  isHigherBetter     Boolean          @default(true) @map("is_higher_better")
  icon               String?          @db.VarChar(50)
  color              String?          @db.VarChar(20)
  metadata           Json?            @db.JsonB
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy          String           @map("created_by") @db.Uuid
  updatedBy          String?          @map("updated_by") @db.Uuid
  deletedAt          DateTime?        @map("deleted_at") @db.Timestamptz(6)
  deletedBy          String?          @map("deleted_by") @db.Uuid
  deletionReason     String?          @map("deletion_reason") @db.Text

  // Relations
  tenant         AdmTenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser  AdmProviderEmployee   @relation("SchGoalTypeCreatedBy", fields: [createdBy], references: [id])
  updatedByUser  AdmProviderEmployee?  @relation("SchGoalTypeUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser  AdmProviderEmployee?  @relation("SchGoalTypeDeletedBy", fields: [deletedBy], references: [id])
  goals          SchGoal[]

  @@unique([tenantId, code, deletedAt], name: "sch_goal_types_tenant_code_unique")
  @@index([category])
  @@index([deletedAt])
  @@map("sch_goal_types")
}

// ----------------------------------------------------------------------------
// TABLE 6/11: sch_goals (MODIFY)
// Description: Objectifs KPI mesurables en temps réel avec gamification
// ----------------------------------------------------------------------------
model SchGoal {
  id                        String         @id @default(uuid()) @db.Uuid
  tenantId                  String         @map("tenant_id") @db.Uuid
  goalTypeId                String?        @map("goal_type_id") @db.Uuid
  goalCategory              GoalCategory?  @map("goal_category")
  targetType                GoalTargetType @map("target_type")
  targetEntityType          String?        @map("target_entity_type") @db.VarChar(50)
  targetEntityId            String?        @map("target_entity_id") @db.Uuid
  periodType                GoalPeriodType @map("period_type")
  periodStart               DateTime       @map("period_start") @db.Date
  periodEnd                 DateTime       @map("period_end") @db.Date
  recurrencePattern         String?        @map("recurrence_pattern") @db.VarChar(100)
  targetValue               Decimal        @map("target_value") @db.Decimal(12, 2)
  currentValue              Decimal?       @default(0) @map("current_value") @db.Decimal(12, 2)
  progressPercent           Decimal?       @map("progress_percent") @db.Decimal(5, 2)
  unit                      String         @db.VarChar(50)
  weight                    Decimal?       @default(1.0) @db.Decimal(5, 2)
  rewardType                GoalRewardType? @map("reward_type")
  rewardAmount              Decimal?       @map("reward_amount") @db.Decimal(10, 2)
  thresholdBronze           Decimal?       @map("threshold_bronze") @db.Decimal(12, 2)
  thresholdSilver           Decimal?       @map("threshold_silver") @db.Decimal(12, 2)
  thresholdGold             Decimal?       @map("threshold_gold") @db.Decimal(12, 2)
  achievementDate           DateTime?      @map("achievement_date") @db.Timestamptz(6)
  lastCalculatedAt          DateTime?      @map("last_calculated_at") @db.Timestamptz(6)
  lastNotifiedAt            DateTime?      @map("last_notified_at") @db.Timestamptz(6)
  notificationFrequencyDays Int?           @map("notification_frequency_days")
  status                    GoalStatus     @default(active)
  notes                     String?        @db.Text
  metadata                  Json?          @db.JsonB
  createdAt                 DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy                 String         @map("created_by") @db.Uuid
  updatedBy                 String?        @map("updated_by") @db.Uuid
  deletedAt                 DateTime?      @map("deleted_at") @db.Timestamptz(6)
  deletedBy                 String?        @map("deleted_by") @db.Uuid
  deletionReason            String?        @map("deletion_reason") @db.Text

  // Relations
  tenant         AdmTenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  goalType       SchGoalType?           @relation(fields: [goalTypeId], references: [id])
  createdByUser  AdmProviderEmployee    @relation("SchGoalCreatedBy", fields: [createdBy], references: [id])
  updatedByUser  AdmProviderEmployee?   @relation("SchGoalUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser  AdmProviderEmployee?   @relation("SchGoalDeletedBy", fields: [deletedBy], references: [id])
  achievements   SchGoalAchievement[]

  @@unique([tenantId, goalTypeId, periodStart, targetEntityId, deletedAt], name: "sch_goals_unique")
  @@index([targetEntityType, targetEntityId, status])
  @@index([progressPercent, status])
  @@index([achievementDate])
  @@index([status, deletedAt])
  @@map("sch_goals")
}

// ----------------------------------------------------------------------------
// TABLE 7/11: sch_goal_achievements (NEW)
// Description: Historique succès objectifs avec paliers et récompenses
// ----------------------------------------------------------------------------
model SchGoalAchievement {
  id                String         @id @default(uuid()) @db.Uuid
  goalId            String         @map("goal_id") @db.Uuid
  achievementDate   DateTime       @map("achievement_date") @db.Timestamptz(6)
  finalValue        Decimal        @map("final_value") @db.Decimal(12, 2)
  thresholdReached  GoalThreshold? @map("threshold_reached")
  rewardGranted     Boolean        @default(false) @map("reward_granted")
  rewardAmount      Decimal?       @map("reward_amount") @db.Decimal(10, 2)
  certificateUrl    String?        @map("certificate_url") @db.VarChar(500)
  notes             String?        @db.Text
  metadata          Json?          @db.JsonB
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy         String         @map("created_by") @db.Uuid

  // Relations
  goal          SchGoal              @relation(fields: [goalId], references: [id], onDelete: Cascade)
  createdByUser AdmProviderEmployee  @relation("SchGoalAchievementCreatedBy", fields: [createdBy], references: [id])

  @@index([goalId, achievementDate])
  @@index([achievementDate])
  @@index([rewardGranted])
  @@map("sch_goal_achievements")
}

// ----------------------------------------------------------------------------
// TABLE 8/11: sch_task_types (NEW)
// Description: Types tâches référentiel avec SLA et template checklist
// ----------------------------------------------------------------------------
model SchTaskType {
  id                   String        @id @default(uuid()) @db.Uuid
  tenantId             String?       @map("tenant_id") @db.Uuid
  code                 String        @db.VarChar(50)
  label                String        @db.VarChar(255)
  category             TaskCategory
  defaultPriority      TaskPriority? @map("default_priority")
  defaultDurationMinutes Int?        @map("default_duration_minutes")
  requiresVerification Boolean       @default(false) @map("requires_verification")
  defaultChecklist     Json?         @map("default_checklist") @db.JsonB
  autoAssignmentRule   Json?         @map("auto_assignment_rule") @db.JsonB
  slaHours             Int?          @map("sla_hours")
  escalationHours      Int?          @map("escalation_hours")
  descriptionTemplate  String?       @map("description_template") @db.Text
  metadata             Json?         @db.JsonB
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy            String        @map("created_by") @db.Uuid
  updatedBy            String?       @map("updated_by") @db.Uuid
  deletedAt            DateTime?     @map("deleted_at") @db.Timestamptz(6)
  deletedBy            String?       @map("deleted_by") @db.Uuid
  deletionReason       String?       @map("deletion_reason") @db.Text

  // Relations
  tenant        AdmTenant?            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser AdmProviderEmployee   @relation("SchTaskTypeCreatedBy", fields: [createdBy], references: [id])
  updatedByUser AdmProviderEmployee?  @relation("SchTaskTypeUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser AdmProviderEmployee?  @relation("SchTaskTypeDeletedBy", fields: [deletedBy], references: [id])
  tasks         SchTask[]

  @@unique([tenantId, code, deletedAt], name: "sch_task_types_tenant_code_unique")
  @@index([category, defaultPriority])
  @@index([deletedAt])
  @@map("sch_task_types")
}

// ----------------------------------------------------------------------------
// TABLE 9/11: sch_tasks (MODIFY)
// Description: Tâches assignées avec workflow validation et escalade
// ----------------------------------------------------------------------------
model SchTask {
  id                       String       @id @default(uuid()) @db.Uuid
  tenantId                 String       @map("tenant_id") @db.Uuid
  taskTypeId               String?      @map("task_type_id") @db.Uuid
  taskCategory             TaskCategory? @map("task_category")
  title                    String       @db.VarChar(255)
  description              String?      @db.Text
  priority                 TaskPriority @default(normal)
  assignedTo               String?      @map("assigned_to") @db.Uuid
  assignedAt               DateTime?    @map("assigned_at") @db.Timestamptz(6)
  assignedBy               String?      @map("assigned_by") @db.Uuid
  targetType               String?      @map("target_type") @db.VarChar(50)
  targetId                 String?      @map("target_id") @db.Uuid
  relatedEntityType        String?      @map("related_entity_type") @db.VarChar(50)
  relatedEntityId          String?      @map("related_entity_id") @db.Uuid
  estimatedDurationMinutes Int?         @map("estimated_duration_minutes")
  actualDurationMinutes    Int?         @map("actual_duration_minutes")
  startDate                DateTime?    @map("start_date") @db.Date
  dueDate                  DateTime?    @map("due_date") @db.Date
  completedAt              DateTime?    @map("completed_at") @db.Timestamptz(6)
  completedBy              String?      @map("completed_by") @db.Uuid
  verificationRequired     Boolean      @default(false) @map("verification_required")
  verifiedBy               String?      @map("verified_by") @db.Uuid
  verifiedAt               DateTime?    @map("verified_at") @db.Timestamptz(6)
  isAutoGenerated          Boolean      @default(false) @map("is_auto_generated")
  generationTrigger        String?      @map("generation_trigger") @db.VarChar(100)
  recurrencePattern        String?      @map("recurrence_pattern") @db.VarChar(100)
  parentTaskId             String?      @map("parent_task_id") @db.Uuid
  blockingTasks            String[]     @map("blocking_tasks") @db.Uuid
  checklist                Json?        @db.JsonB
  attachments              Json?        @db.JsonB
  reminderSentAt           DateTime?    @map("reminder_sent_at") @db.Timestamptz(6)
  reminderFrequencyDays    Int?         @map("reminder_frequency_days")
  escalationLevel          Int          @default(0) @map("escalation_level")
  escalatedTo              String?      @map("escalated_to") @db.Uuid
  tags                     String[]     @db.Text
  status                   TaskStatus   @default(pending)
  metadata                 Json?        @db.JsonB
  createdAt                DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy                String       @map("created_by") @db.Uuid
  updatedBy                String?      @map("updated_by") @db.Uuid
  deletedAt                DateTime?    @map("deleted_at") @db.Timestamptz(6)
  deletedBy                String?      @map("deleted_by") @db.Uuid
  deletionReason           String?      @map("deletion_reason") @db.Text

  // Relations
  tenant            AdmTenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  taskType          SchTaskType?          @relation(fields: [taskTypeId], references: [id])
  assignee          AdmMember?            @relation("SchTaskAssignedTo", fields: [assignedTo], references: [id])
  assigner          AdmMember?            @relation("SchTaskAssignedBy", fields: [assignedBy], references: [id])
  completer         AdmMember?            @relation("SchTaskCompletedBy", fields: [completedBy], references: [id])
  verifier          AdmMember?            @relation("SchTaskVerifiedBy", fields: [verifiedBy], references: [id])
  escalatedToUser   AdmMember?            @relation("SchTaskEscalatedTo", fields: [escalatedTo], references: [id])
  parentTask        SchTask?              @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subTasks          SchTask[]             @relation("TaskHierarchy")
  createdByUser     AdmProviderEmployee   @relation("SchTaskCreatedBy", fields: [createdBy], references: [id])
  updatedByUser     AdmProviderEmployee?  @relation("SchTaskUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser     AdmProviderEmployee?  @relation("SchTaskDeletedBy", fields: [deletedBy], references: [id])
  comments          SchTaskComment[]
  history           SchTaskHistory[]

  @@index([assignedTo, status, dueDate])
  @@index([taskCategory, priority])
  @@index([isAutoGenerated, generationTrigger])
  @@index([targetType, targetId, status])
  @@index([tags], type: Gin)
  @@index([status, deletedAt])
  @@map("sch_tasks")
}

// ----------------------------------------------------------------------------
// TABLE 10/11: sch_task_comments (NEW)
// Description: Commentaires tâches pour collaboration
// ----------------------------------------------------------------------------
model SchTaskComment {
  id           String          @id @default(uuid()) @db.Uuid
  taskId       String          @map("task_id") @db.Uuid
  commentType  TaskCommentType @map("comment_type")
  authorId     String          @map("author_id") @db.Uuid
  commentText  String          @map("comment_text") @db.Text
  attachments  Json?           @db.JsonB
  isInternal   Boolean         @default(false) @map("is_internal")
  metadata     Json?           @db.JsonB
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  task   SchTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author AdmMember @relation(fields: [authorId], references: [id])

  @@index([taskId, createdAt])
  @@index([authorId])
  @@index([commentType])
  @@map("sch_task_comments")
}

// ----------------------------------------------------------------------------
// TABLE 11/11: sch_task_history (NEW)
// Description: Audit trail complet changements tâches
// ----------------------------------------------------------------------------
model SchTaskHistory {
  id           String         @id @default(uuid()) @db.Uuid
  taskId       String         @map("task_id") @db.Uuid
  changedBy    String         @map("changed_by") @db.Uuid
  changeType   TaskChangeType @map("change_type")
  oldValues    Json?          @map("old_values") @db.JsonB
  newValues    Json?          @map("new_values") @db.JsonB
  changeReason String?        @map("change_reason") @db.Text
  metadata     Json?          @db.JsonB
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  task      SchTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedByUser AdmMember @relation(fields: [changedBy], references: [id])

  @@index([taskId, createdAt])
  @@index([changedBy])
  @@index([changeType])
  @@map("sch_task_history")
}

// ----------------------------------------------------------------------------
// TABLE BONUS: sch_locations (NEW - OPTIONNEL)
// Description: Zones géographiques pour optimisation dispatch
// ----------------------------------------------------------------------------
model SchLocation {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  name        String    @db.VarChar(255)
  code        String    @db.VarChar(50)
  polygon     Json?     @db.JsonB // GeoJSON polygon
  city        String?   @db.VarChar(100)
  country     String?   @db.VarChar(100)
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  metadata    Json?     @db.JsonB
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String    @map("created_by") @db.Uuid
  updatedBy   String?   @map("updated_by") @db.Uuid
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy   String?   @map("deleted_by") @db.Uuid
  deletionReason String? @map("deletion_reason") @db.Text

  // Relations
  tenant        AdmTenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUser AdmProviderEmployee   @relation("SchLocationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser AdmProviderEmployee?  @relation("SchLocationUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser AdmProviderEmployee?  @relation("SchLocationDeletedBy", fields: [deletedBy], references: [id])
  shifts        SchShift[]

  @@unique([tenantId, code, deletedAt], name: "sch_locations_tenant_code_unique")
  @@index([isActive, deletedAt])
  @@index([city, country])
  @@map("sch_locations")
}
